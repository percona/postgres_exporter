dist: bionic
language: go
os: linux

go:
  - 1.15.x
  - 1.14.x
  - tip

jobs:
  allow_failures:
    - go: tip

# skip non-trunk PMM-XXXX branch builds, but still build pull requests
branches:
  except:
    - /^PMM\-\d{4}/

env:
  global:
    # REVIEWDOG_GITHUB_API_TOKEN
    secure: w+61ClEP7mmr53RaNDFFFcA1qw39CRIUCG9PBYOcuw7TqvFnn8e16IyWWKEjE0/Jd8lzL1xJYi3uNj4tqqWFp36bbgpjTh5QbUGAOEpRr2pPFCpl6Xhg8WGwlElU2tJIKlUqwWfZOJeD3AtALF6/IeAh9e7+Gp1xa22lQ7RAt5aaC3Z1qV2eo2e1kXa8WrBO5N+uTriu9tpBdPDqQFgFdExcl0tVsSbfidxTAe9tykdReKdrgz89rrJ310kpPe3vPSNk5nxPJj3y3S6eXer8wMM5whY5hCcyExlP7sezptASN083kdBpq/K53YGFQiqF0Nac3OogGs6vM0s9BB5hl/I1WXxKCy0fxB6x7+Z2oRLLUGbtriym5LgPyQo5FRdjrS3tonhnrMOb4Vsa7ai8UbFNETxCPzlRZj8x0aA1H6f6GbIrZ/EfBTJyxwE+xAbvFKwOEomC6dkGwCBClT+D7wqaYICfV21csYlTGCw5gPNrbZIZv5mntU/DRTH2mumYRpgzEm79/bRjXhL2mWzjL+LrBNgVJs4/8YsSSkE1Yu4jmQBSDUMbZHX1r63ZSAbjABhugtv1v6GZV0914Cv0g/infBlN8b7n0HDS7TcwqoWK5APP2rI77Z8hS1YLtsQjRoPOOFqhsRElqqsAwKhYFXHanYeKygrwO6YYXPANQ+8=
  jobs:
    - POSTGRESQL_IMAGE=postgres:9.4
    - POSTGRESQL_IMAGE=postgres:9.5
    - POSTGRESQL_IMAGE=postgres:9.6
    - POSTGRESQL_IMAGE=postgres:10
    - POSTGRESQL_IMAGE=postgres:11
    - POSTGRESQL_IMAGE=postgres:12

services:
  - docker

go_import_path: github.com/percona/postgres_exporter

install:
  # install reviewdog and golangci-lin
  - curl https://raw.githubusercontent.com/reviewdog/reviewdog/master/install.sh| sh -s
  - curl https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s latest

before_script:
  # static analyze
  - bin/golangci-lint run -c=.golangci-required.yml --out-format=line-number | bin/reviewdog -f=golangci-lint -level=error -reporter=github-pr-check
  - bin/golangci-lint run -c=.golangci.yml --out-format=line-number | bin/reviewdog -f=golangci-lint -level=error -reporter=github-pr-review
  # use the same uid as in container
  - sudo usermod -u 999 postgres
  - sudo chown postgres:postgres testdata/ssl/*
  - sudo chmod 0600 testdata/ssl/*

  - docker --version
  - docker-compose --version
  - docker-compose up -d

script:
  - make
  - make test

after_failure:
  - docker-compose logs

notifications:
  email: false
